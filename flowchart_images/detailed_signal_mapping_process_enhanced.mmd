flowchart TB
    subgraph Sources["ğŸ“Š Multi-Source Data Input"]
        Hatching["ğŸ›¤ï¸ Hatching Paths<br/>Points: (x, y, z)<br/>Signals: power, speed, energy,<br/>hatch_spacing, overlap_percentage,<br/>layer_thickness, scan_strategy<br/>data_index for mapping"]
        Laser["âš¡ Laser Parameters<br/>Points: (x, y, z)<br/>Signals: power, speed<br/>data_index for mapping"]
        CT["ğŸ”¬ CT Scans<br/>Points: (x, y, z)<br/>Signals: density, porosity,<br/>defect_map, defect_locations"]
        ISPM["ğŸŒ¡ï¸ ISPM Monitoring<br/>Points: (x, y, z)<br/>Signals: melt_pool_temperature,<br/>melt_pool_size, peak_temperature,<br/>cooling_rate, temperature_gradient,<br/>process_events"]
    end

    subgraph Step1["Step 1: Query Raw Data"]
        Query["Query with Filters<br/>â€¢ Spatial: bbox, layer range<br/>â€¢ Temporal: time range<br/>â€¢ Signal types"]
    end

    subgraph Step2["Step 2: Coordinate Transformation<br/>& Calibration Correction"]
        Transform["Transform to Unified CS<br/>p_T = O_T + s_T Â· R_T Â· (R_Sâ»Â¹ Â· (p_S - O_S) / s_S)<br/>+ Apply Calibration Corrections"]
    end

    subgraph Step3["Step 3: Voxel Index Calculation"]
        VoxelIdx["Calculate Voxel Indices<br/>i = âŒŠ(x - x_min) / râŒ‹<br/>j = âŒŠ(y - y_min) / râŒ‹<br/>k = âŒŠ(z - z_min) / râŒ‹"]
    end

    subgraph Step4["Step 4: Interpolation/Aggregation"]
        InterpMethod{Select Method}
        Nearest["Nearest Neighbor<br/>v = s_p"]
        Linear["Linear<br/>v = Î£ w_p Â· s_p"]
        IDW["IDW<br/>v = Î£(s_p/d_p^p) / Î£(1/d_p^p)"]
        KDE["Gaussian KDE<br/>v = Î£ s_p Â· K_h(||p-c||)"]
        Aggregate["Aggregate Multiple Points<br/>mean, median, max, min"]
    end

    subgraph Step5["Step 5: Store Signals<br/>& Post-Mapping Correction"]
        Store["Store in Voxel Grid<br/>V[i,j,k] = signal_value<br/>Sparse dictionary storage<br/>Optional: Apply post-mapping corrections"]
    end

    subgraph Output["ğŸ“¦ Unified Voxel Domain<br/>(Calibrated & Corrected)"]
        Grid["3D Voxel Grid<br/>â€¢ Uniform/Adaptive/Multi-Res<br/>â€¢ Multiple signals per voxel<br/>â€¢ Metadata: resolution, bbox<br/>â€¢ Calibrated & corrected signals"]
    end

    Hatching --> Query
    Laser --> Query
    CT --> Query
    ISPM --> Query

    Query --> Transform
    Transform --> VoxelIdx
    VoxelIdx --> InterpMethod

    InterpMethod -->|Dense data| Nearest
    InterpMethod -->|Smooth signals| Linear
    InterpMethod -->|Sparse data| IDW
    InterpMethod -->|Uncertainty needed| KDE

    Nearest --> Aggregate
    Linear --> Aggregate
    IDW --> Aggregate
    KDE --> Aggregate

    Aggregate --> Store
    Store --> Grid

    classDef source fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef step fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef method fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef output fill:#e8f5e9,stroke:#388e3c,stroke-width:3px
    classDef decision fill:#ffebee,stroke:#c62828,stroke-width:2px

    class Hatching,Laser,CT,ISPM source
    class Query,Transform,VoxelIdx,Aggregate,Store step
    class Nearest,Linear,IDW,KDE method
    class Grid output
    class InterpMethod decision

